# 射线求交公式

![image-20240111183016199](.\image-20240111183016199.png)



如图：我们在屏幕上鼠标从A点移动到A'，需要将世界空间中的B点移动到B'点。基于我们此前的射线检测算法，我们能够知道屏幕上A'点的射线转换到世界空间中的射线$\vec{A'}$的方向$V_{A'}$,我们假设A'点已经被我们从屏幕坐标转换到了世界空间中，那么射线$\vec{A'}$的公式就为(t1为时间)：
$$
\vec{A'} = A' + \vec{V_{A'}}t_1
$$
同理，对于我们需要移动的B点来说，它的世界空间的坐标点B，以及他的方向$\vec{V_B}$我们是知道的，那么B沿着$\vec{V_B}$方向的射线公式就为（t2为B射线的移动时间）：
$$
\vec{B} = B + \vec{V_B}t_2
$$
注意：上述所有公式都是基于同一个世界坐标空间中的量。因为这些量中，坐标A', B，方向V我们都是知道的，所以唯一的未知量就是两个时间常量t。

那么，此时，如何求B'的坐标呢？很简单，这就变成了求两条射线相交点的坐标，也就是我们上述说的，假设$\vec{A'}$射线经过t1时间，$\vec{B}射线经过t2时间他们两相交与点B'，那么我们就有公式：
$$
\vec{A'} = A' + \vec{V_{A'}}t_1
\\
=
\\
\vec{B} = B + \vec{V_B}t_2
\\
A' + \vec{V_{A'}}t_1 = B + \vec{V_B}t_2
\\ \\
\vec{V_{A'}}t_1 = B - A' + \vec{V_B}t_2
$$
因为V是向量，A,B是坐标，所以这里不能简单的做等式除法消去V。这里我们可以采用左右两边同时叉乘向量（方向）$\vec{V_B}$，得到
$$
t_1 (\vec{V_{A'}} \times \vec{V_B} ) = (B - A') \times \vec{V_B} + \vec{V_B} \times \vec{V_B} t_2
$$
两个方向相同的向量叉乘结果为0，那么这样t2就被消掉，得到
$$
t_1 (\vec{V_{A'}} \times \vec{V_B} ) = (B - A') \times \vec{V_B}
$$
然后我们需要求出t1，就需要将$(\vec{V_{A'}} \times \vec{V_B} )$移到式子右边，但是对于向量来说，不能直接简单的用除法进行消元，这里我们左右两边同时点乘上$(\vec{V_{A'}} \times \vec{V_B} )$,得到
$$
t_1 (\vec{V_{A'}} \times \vec{V_B} ) \cdot (\vec{V_{A'}} \times \vec{V_B} ) = ((B - A') \times \vec{V_B}) \cdot (\vec{V_{A'}} \times \vec{V_B} )
$$
得到
$$
t_1 ||\vec{V_{A'}} \times \vec{V_B}||^2 = ((B - A') \times \vec{V_B}) \cdot (\vec{V_{A'}} \times \vec{V_B} )
\\
\\
t_1 = \frac{((B - A') \times \vec{V_B}) \cdot (\vec{V_{A'}} \times \vec{V_B} )}{||\vec{V_{A'}} \times \vec{V_B}||^2}
$$
同理，对于t2的求法，也是一样的，只是消的元不同。但是无论我们求出t1还是t2，都可以带入公式得到两射线相交点B'的坐标