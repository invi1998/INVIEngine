# PBR

PBR（Physically Based Rendering），即基于物理原理的渲染，是一种用于模拟真实世界中光照和材质的渲染技术。它通过使用物理基础知识来模拟光线在材质表面上的反射、折射、散射等现象，从而能够更准确地模拟真实世界中的光学行为。

PBR通常包含以下两个方面：

1. 材质表达：PBR使用归一化的BRDF（Bidirectional Reflectance Distribution Function）来表示材质的颜色和反射性质。通常使用Cook-Torrance或者Ward等经典BRDF模型或其变种作为基础，配合多重散射等高级特性进行描述。

2. 光照模拟：PBR使用HDR（High Dynamic Range）环境贴图来模拟真实世界中的光照环境。同时，还可以使用IBL（Image-Based Lighting）技术来实现基于图片的间接光照。这些技术都能更好地模拟真实世界中的光照情况。

在PBR中，通常采用以下工作流程：

1. 在3D建模软件中创建模型，并分配材质贴图。其中，使用PBR材质的话需要提供漫反射贴图、高光贴图、法线贴图、金属度贴图等。

2. 将模型导入游戏引擎，并使用PBR着色器进行渲染。在着色器中，使用BRDF计算每个像素的反射率，再结合环境光、平行光、点光源等进行光照模拟。

3. 通过HDR环境贴图来模拟全局光照，通过IBL技术来模拟间接光照。使用这些技术能够更好地模拟真实世界中的光照情况。

总之，PBR是一种比较先进的渲染技术，可以更准确地模拟真实世界中的光照和材质特性。由于它需要考虑很多因素，因此比较复杂，但如果应用得当，可以获得更真实、更优秀的渲染效果。



## 微表面理论

微表面理论是PBR渲染中的重要理论之一，它解释了材质表面微结构对光的反射、散射等现象的影响，并提供了计算BRDF的方法。

微表面理论认为材质表面是由许多微小的几何形状（也称为“微表面”或“微面元”）组成的。每个微表面都可以看作一个微小的镜面反射体，其法线方向随机分布于半球面上。当光照射到微表面时，根据法向和入射光线方向，这些微表面会反射、折射、散射、吸收等光线，从而产生不同的光学效果。微表面理论通过计算所有微表面的反射率来模拟整个材质表面的反射率，并最终用于计算BRDF。

在微表面理论中，常用的基本参数包括：

- 法向分布函数（ND）：描述微表面法线分布的函数，通常使用高斯分布、Beckmann分布、GGX分布等函数。

- 几何遮挡函数（G）：描述微表面间相互遮挡的程度，通常使用Smith遮挡函数等。

- 菲涅尔反射系数（F）：描述入射光线与表面交互时的反射比例，通常使用Schlick近似公式等。

这些参数的组合形成了通用的微表面 BRDF 公式。

微表面理论的优点是能够更准确地模拟真实世界中复杂的光学效果，并且能够很好地适应各种光照条件。但是，微表面理论也存在一些缺陷，例如需要考虑较多的参数，计算量大等。另外，微表面理论的正确性也取决于材质表面微结构的准确建模，因此需要实验验证来验证模型的准确性。



## PBR能量守恒

能量守恒是物理学的基本原则之一，也是PBR渲染中的重要原则之一。在PBR渲染中，能量守恒指的是光的吸收和反射过程中，入射光的总能量等于反射光和散射光的总能量。

在PBR渲染中，通常使用归一化的BRDF公式来计算材质表面对光的反射率。这个公式中包含了多个参数，例如法向分布函数、几何遮挡函数、菲涅尔反射系数等。其中，菲涅尔反射系数描述的是入射光线与表面相交时的反射比例，它决定了反射光线的强度。同时，由于入射光线的总能量不变，因此入射光线的能量需要被正确地分配给反射光线和散射光线。

为了保证能量守恒，在计算BRDF时，需要满足以下两个条件：

1. 能量守恒：入射光线的总能量等于反射光线和散射光线的总能量，即入射光线的能量通过反射和散射被完全消耗。

2. BRDF值在0到1之间：BRDF值表示单位入射光线方向上反射光线的能量占入射光线的能量的比例，因此BRDF值必须在0到1之间。

为了达到这些目标，可以采用以下方法：

1. 归一化BRDF：将BRDF公式中的所有项都除以反射光线方向上的能量，并乘以入射光线方向上的立体角，从而使BRDF值在0到1之间。

2. 对能量进行调整：为了满足能量守恒，可以根据BRDF公式的结果对反射光线或者散射光线的能量进行调整。具体来说，可以根据反射光线和散射光线的能量比例以及菲涅尔反射系数等参数来对能量进行调整，从而保证入射光线的总能量不变。

总之，能量守恒是PBR渲染中的重要原则之一，能够确保渲染结果更加逼真和合理。



## 辐射通量

辐射通量是光学中的一个基本概念，用于描述光源向周围空间辐射的光能量。其单位为瓦特（W），表示每秒钟向周围空间辐射的光能量大小。

辐射通量通常使用字母Φ表示，它的公式可以写成：

Φ = dQ / dt

其中，dQ表示光源在时间dt内向周围空间发出的能量，Φ表示单位时间内的辐射通量。根据定义，一个光源的辐射通量越大，则它向周围空间辐射的光能量也就越多，因此我们会感觉到该光源更加明亮。

需要注意的是，辐射通量只描述了光源向周围空间发出的光能量，而没有考虑光线传输过程中的损失等情况。因此，在实际应用中，我们往往还需考虑能够被接收器接收到的辐射通量，即辐射通量经过光线传输后在接收器上的能量密度。

在PBR渲染中，辐射通量是非常重要的物理量之一，因为它与光源的亮度、颜色等都有密切关系。在计算场景中的光照时，我们需要先计算每个光源的辐射通量，然后根据光线与材质表面的交点位置和法线方向来计算接收到的辐射通量，并最终计算材质表面的颜色和光照效果。

总之，辐射通量是光学中的一个基本概念，用于描述光源向周围空间辐射的光能量。在PBR渲染中，它是计算光照和材质反射等重要物理量的基本参数之一。



## 立体角

立体角是空间角的一种，用于描述在三维空间中某个位置上的整个空间范围，其单位为立体弧度（sr）。

当我们站在球形表面上观察球心时，我们可以将球面划分成无数个小区域，每个小区域都对应着球心处的一个立体角。这个立体角的大小取决于球面上该小区域所占据的面积以及球心与该小区域之间的夹角。

立体角的计算公式可以写成：

Ω = A / r²

其中，Ω表示立体角的大小，A表示该区域在球面上所占据的面积，r表示球心到该区域的距离。由此可知，当球心到该区域的距离越远，则该小区域的面积越小，立体角也就越小。

需要注意的是，立体角和平面角不同，它更多地描述的是三维空间中的角度范围，而不是平面上的角度范围。因此，立体角通常被用于描述光照、辐射等三维空间中的物理量。

在PBR渲染中，立体角是非常重要的物理量之一。例如，当我们计算材质表面接收到来自某个光源的辐射能量时，我们需要先计算该光源向材质表面发出的辐射通量，然后根据光线传输路径和交点位置等信息，计算该交点处的立体角大小，并最终计算材质表面接收到的辐射能量。

总之，立体角是空间角的一种，用于描述在三维空间中某个位置上的整个空间范围，其单位为立体弧度。在PBR渲染中，它是计算光照和材质反射等重要物理量的基本参数之一。

![image-20230912142717518](.\image-20230912142717518.png)



## 辐射能量

辐射能量是指通过电磁波、粒子流等辐射方式传输的能量。在物理学中，辐射能量通常用于描述电磁波、光线等在空间中传播时所携带的能量。其单位为焦耳（J），表示一定时间内传输的能量大小。

在PBR渲染中，辐射能量也是一个重要的物理量。例如，在计算场景中的光照和材质表面的反射时，我们需要考虑光源向周围空间辐射的能量、光线传输过程中的能量损失等因素，以保证渲染结果更加真实和准确。

辐射能量通常使用下列公式进行计算：

E = hν

其中，E表示辐射能量，h表示普朗克常数（其值约为6.62607015×10^-34 J·s），ν表示光线或电磁波的频率。这个公式说明了辐射能量与光线或电磁波的频率之间存在着密切的关系。当光线或电磁波的频率越高，则它所携带的能量也就越多，从而在与物体交互时产生的效果也会更强烈。

需要注意的是，在实际应用中，由于辐射能量的大小会受到诸多复杂因素的影响（例如能量损失、散射、吸收等），因此我们需要对这些影响因素进行综合考虑，并采用适当的物理模型和计算方法来进行准确的计算。

总之，辐射能量是指通过电磁波、粒子流等辐射方式传输的能量，是PBR渲染中的一个重要物理量。在计算场景中的光照和材质表面的反射时，我们需要考虑辐射能量、能量损失、散射、吸收等因素，以保证渲染结果更加真实和准确。



## 辐射强度

辐射强度是指辐射源在某个方向上单位时间内通过单位立体角所辐射的能量。其单位为瓦特每平方米每立体弧度（W/m²/sr），通常用符号I来表示。

在物理学中，辐射强度是描述辐射源释放能量的一种重要物理量，主要用于计算光线、电磁波等在空间传播时的能量大小。例如，在计算场景中的光照时，我们需要考虑光源在各个方向上释放的辐射能量，并根据距离、角度等因素进行衰减和分布，以便更加真实地模拟光线与物体相互作用的效果。

辐射强度可以使用下列公式进行计算：

I = dΦ / (cosθ dA dt dΩ)

其中，I表示辐射强度，dΦ表示通过某个表面区域的辐射通量变化量，θ表示该表面法线与某个给定方向之间的夹角，dA表示该表面区域的面积，dt表示时间间隔，dΩ表示该方向的立体角。

需要注意的是，由于辐射强度通常会受到诸多因素（例如距离、角度、散射等）的影响，因此在实际应用中，我们需要对这些影响因素进行综合考虑，并采用适当的物理模型和计算方法来进行准确的计算。

总之，辐射强度是指辐射源在某个方向上单位时间内通过单位立体角所辐射的能量，是PBR渲染中的一个重要物理量。在计算场景中的光照和材质表面的反射时，我们需要考虑辐射强度和其它因素，以保证渲染结果更加真实和准确。



## 辐照方程

辐照方程（Radiance Equation）是计算光照和材质表面反射的一种重要物理模型，它描述了在某个点上，入射的光线经过反射、折射等作用后，最终到达该点的能量大小。辐照方程通常可以使用下列公式来描述：

Lp = Le + ∫[f(p, x) × Lx × cosθ] dω

其中，Lp表示在某个点p上观察到的辐射强度，Le表示从该点向外发射的辐射强度，f(p,x)表示表面函数，用于描述材质表面对光的反射和散射特性，Lx表示从某个其他点x出发到达该点p的辐射能量，cosθ表示x的法线与xp之间的夹角。

需要注意的是，由于辐照方程涉及到多个因素的相互作用，例如入射光线、表面反射、散射、吸收等，因此在实际应用中，我们需要对这些因素进行综合考虑，并采用适当的数值方法来求解辐照方程，以保证渲染结果更加真实和准确。

总之，辐照方程是计算光照和材质表面反射的一种重要物理模型，在PBR渲染中得到广泛应用。通过求解辐照方程，我们可以计算出场景中各个点的辐射强度和颜色，以实现高品质的渲染效果。



### 辐射度和辐射照度

辐射度和辐射照度是两个与辐射能量密切相关的物理量，它们在不同的应用场景中有着不同的含义。

辐射度（Radiance）通常指单位时间内通过单位面积、在某个方向上通过空间传输的辐射能量。其单位为瓦特每平方米每立体弧度（W/m²/sr），表示辐射源在某个方向上单位时间内通过单位立体角所辐射的能量大小。在计算光照和材质表面反射时，我们需要考虑光源在各个方向上释放的辐射能量，并根据距离、角度等因素进行衰减和分布，以便更加真实地模拟光线与物体相互作用的效果。

辐射照度（Irradiance）则通常指单位时间内通过单位面积、垂直于某个方向的辐射能量。其单位为瓦特每平方米（W/m²），表示在某个位置上单位面积内接收到的辐射能量大小。在计算场景中各个点的光照时，我们需要考虑光源对该点的辐照强度，以及该点表面的反射率、散射率等因素，从而计算出该点的光照值。

需要注意的是，在实际应用中，这两个物理量通常会受到多种因素的影响，例如距离、角度、能量损失、散射、吸收等，因此在进行具体计算时，我们需要对这些影响因素进行综合考虑，并采用适当的物理模型和计算方法来进行准确的计算。

总之，辐射度和辐射照度是描述辐射能量密度的两个重要物理量，在计算光照和材质表面反射时发挥着重要的作用。我们需要了解它们的定义、单位和计算方法，并结合具体场景进行综合分析和计算，以保证渲染结果更加真实和准确。



## 渲染方程

渲染方程（Rendering Equation）是一种基于物理学原理的渲染模型，用于计算场景中各个点的颜色和光照效果。该方程由James Kajiya在1986年提出，被认为是计算机图形学领域的一个重要贡献。

渲染方程通常使用下列公式进行描述：

Lp = Le + ∫[f(p, x) × Lx × cosθ × G(p,x) / (r^2)] dω

其中，Lp表示在某个点p上观察到的辐射强度，Le表示从该点向外发射的辐射强度，f(p,x)表示表面函数，用于描述材质表面对光的反射和散射特性，Lx表示从某个其他点x出发到达该点p的辐射能量，cosθ表示x的法线与xp之间的夹角，G(p,x)表示阴影因子，考虑了光源与其他物体之间的遮挡情况，r表示x到p的距离。

需要注意的是，渲染方程涉及到多个因素的相互作用，例如入射光线、表面反射、散射、吸收、阴影等，因此在实际应用中，我们需要对这些因素进行综合考虑，并采用适当的数值方法来求解渲染方程，以保证渲染结果更加真实和准确。

总之，渲染方程是一种基于物理学原理的渲染模型，在PBR渲染中得到广泛应用。通过求解渲染方程，我们可以计算出场景中各个点的颜色和光照效果，以实现高品质的渲染效果。

该方程还可以改写为
$$
L_0(p, \omega_o) = \int_{\Omega}{f_r(p, \omega_i,\omega_o)L_i(p, \omega_i)n\cdot \omega_i} {\rm d_{\omega_i}}
$$

- $L_o(p, \omega_o)$ 即我们要求的反射能量
- p 即顶点位置信息
- $\omega_i$ 入射光线
- $\omega_o$ 反射光线
- $f_r(p, \omega_i,\omega_o)$ 就是我们常说的BRDF
- $L_i(p, \omega_i)$ 即光线的入射能量
- $n\cdot \omega_i$ 表示的含义是单位面积中的一个余弦分量
- 最后对我们这3个部分做了一个积分，即得到我们最终的一个渲染结果



## BRDF

BRDF（Bidirectional Reflectance Distribution Function）是一种用于描述材质表面反射特性的函数，通常用于计算光线在反射后的强度和颜色，是PBR渲染过程中的一个重要概念。

BRDF函数描述了入射光线与表面相互作用后的反射情况。它将入射光线的颜色、方向和表面法线等因素作为输入参数，并输出反射光线的颜色和方向等信息。通常情况下，BRDF函数可以使用下列公式进行描述：
$$
f_r (ωi, ωo) = dL_o (ωo) / ( L_i (ωi) cosθi dωi )
$$
其中，f_r表示BRDF函数，ωi和ωo分别表示入射光线和反射光线的方向向量，Li和Lo分别表示入射光线和反射光线的辐射度，cosθi表示入射光线与表面法线之间的夹角，dωi表示入射光线的立体角。

需要注意的是，BRDF函数通常会受到多种因素的影响，例如入射光线、表面材质、视角、环境光照等，因此在实际应用中，我们需要对这些因素进行综合考虑，并采用适当的物理模型和数值方法来计算BRDF函数，以保证渲染结果更加真实和准确。

总之，BRDF是一种用于描述材质表面反射特性的函数，在PBR渲染中发挥着重要的作用。通过计算BRDF函数，我们可以模拟出入射光线在经过反射、折射等作用后的强度和颜色，从而实现高品质的渲染效果。