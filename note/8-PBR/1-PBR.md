# PBR

PBR（Physically Based Rendering），即基于物理原理的渲染，是一种用于模拟真实世界中光照和材质的渲染技术。它通过使用物理基础知识来模拟光线在材质表面上的反射、折射、散射等现象，从而能够更准确地模拟真实世界中的光学行为。

PBR通常包含以下两个方面：

1. 材质表达：PBR使用归一化的BRDF（Bidirectional Reflectance Distribution Function）来表示材质的颜色和反射性质。通常使用Cook-Torrance或者Ward等经典BRDF模型或其变种作为基础，配合多重散射等高级特性进行描述。

2. 光照模拟：PBR使用HDR（High Dynamic Range）环境贴图来模拟真实世界中的光照环境。同时，还可以使用IBL（Image-Based Lighting）技术来实现基于图片的间接光照。这些技术都能更好地模拟真实世界中的光照情况。

在PBR中，通常采用以下工作流程：

1. 在3D建模软件中创建模型，并分配材质贴图。其中，使用PBR材质的话需要提供漫反射贴图、高光贴图、法线贴图、金属度贴图等。

2. 将模型导入游戏引擎，并使用PBR着色器进行渲染。在着色器中，使用BRDF计算每个像素的反射率，再结合环境光、平行光、点光源等进行光照模拟。

3. 通过HDR环境贴图来模拟全局光照，通过IBL技术来模拟间接光照。使用这些技术能够更好地模拟真实世界中的光照情况。

总之，PBR是一种比较先进的渲染技术，可以更准确地模拟真实世界中的光照和材质特性。由于它需要考虑很多因素，因此比较复杂，但如果应用得当，可以获得更真实、更优秀的渲染效果。



## 微表面理论

微表面理论是PBR渲染中的重要理论之一，它解释了材质表面微结构对光的反射、散射等现象的影响，并提供了计算BRDF的方法。

微表面理论认为材质表面是由许多微小的几何形状（也称为“微表面”或“微面元”）组成的。每个微表面都可以看作一个微小的镜面反射体，其法线方向随机分布于半球面上。当光照射到微表面时，根据法向和入射光线方向，这些微表面会反射、折射、散射、吸收等光线，从而产生不同的光学效果。微表面理论通过计算所有微表面的反射率来模拟整个材质表面的反射率，并最终用于计算BRDF。

在微表面理论中，常用的基本参数包括：

- 法向分布函数（ND）：描述微表面法线分布的函数，通常使用高斯分布、Beckmann分布、GGX分布等函数。

- 几何遮挡函数（G）：描述微表面间相互遮挡的程度，通常使用Smith遮挡函数等。

- 菲涅尔反射系数（F）：描述入射光线与表面交互时的反射比例，通常使用Schlick近似公式等。

这些参数的组合形成了通用的微表面 BRDF 公式。

微表面理论的优点是能够更准确地模拟真实世界中复杂的光学效果，并且能够很好地适应各种光照条件。但是，微表面理论也存在一些缺陷，例如需要考虑较多的参数，计算量大等。另外，微表面理论的正确性也取决于材质表面微结构的准确建模，因此需要实验验证来验证模型的准确性。



## PBR能量守恒

能量守恒是物理学的基本原则之一，也是PBR渲染中的重要原则之一。在PBR渲染中，能量守恒指的是光的吸收和反射过程中，入射光的总能量等于反射光和散射光的总能量。

在PBR渲染中，通常使用归一化的BRDF公式来计算材质表面对光的反射率。这个公式中包含了多个参数，例如法向分布函数、几何遮挡函数、菲涅尔反射系数等。其中，菲涅尔反射系数描述的是入射光线与表面相交时的反射比例，它决定了反射光线的强度。同时，由于入射光线的总能量不变，因此入射光线的能量需要被正确地分配给反射光线和散射光线。

为了保证能量守恒，在计算BRDF时，需要满足以下两个条件：

1. 能量守恒：入射光线的总能量等于反射光线和散射光线的总能量，即入射光线的能量通过反射和散射被完全消耗。

2. BRDF值在0到1之间：BRDF值表示单位入射光线方向上反射光线的能量占入射光线的能量的比例，因此BRDF值必须在0到1之间。

为了达到这些目标，可以采用以下方法：

1. 归一化BRDF：将BRDF公式中的所有项都除以反射光线方向上的能量，并乘以入射光线方向上的立体角，从而使BRDF值在0到1之间。

2. 对能量进行调整：为了满足能量守恒，可以根据BRDF公式的结果对反射光线或者散射光线的能量进行调整。具体来说，可以根据反射光线和散射光线的能量比例以及菲涅尔反射系数等参数来对能量进行调整，从而保证入射光线的总能量不变。

总之，能量守恒是PBR渲染中的重要原则之一，能够确保渲染结果更加逼真和合理。



## 辐射通量

辐射通量是光学中的一个基本概念，用于描述光源向周围空间辐射的光能量。其单位为瓦特（W），表示每秒钟向周围空间辐射的光能量大小。

辐射通量通常使用字母Φ表示，它的公式可以写成：

Φ = dQ / dt

其中，dQ表示光源在时间dt内向周围空间发出的能量，Φ表示单位时间内的辐射通量。根据定义，一个光源的辐射通量越大，则它向周围空间辐射的光能量也就越多，因此我们会感觉到该光源更加明亮。

需要注意的是，辐射通量只描述了光源向周围空间发出的光能量，而没有考虑光线传输过程中的损失等情况。因此，在实际应用中，我们往往还需考虑能够被接收器接收到的辐射通量，即辐射通量经过光线传输后在接收器上的能量密度。

在PBR渲染中，辐射通量是非常重要的物理量之一，因为它与光源的亮度、颜色等都有密切关系。在计算场景中的光照时，我们需要先计算每个光源的辐射通量，然后根据光线与材质表面的交点位置和法线方向来计算接收到的辐射通量，并最终计算材质表面的颜色和光照效果。

总之，辐射通量是光学中的一个基本概念，用于描述光源向周围空间辐射的光能量。在PBR渲染中，它是计算光照和材质反射等重要物理量的基本参数之一。



## 立体角

立体角是空间角的一种，用于描述在三维空间中某个位置上的整个空间范围，其单位为立体弧度（sr）。

当我们站在球形表面上观察球心时，我们可以将球面划分成无数个小区域，每个小区域都对应着球心处的一个立体角。这个立体角的大小取决于球面上该小区域所占据的面积以及球心与该小区域之间的夹角。

立体角的计算公式可以写成：

Ω = A / r²

其中，Ω表示立体角的大小，A表示该区域在球面上所占据的面积，r表示球心到该区域的距离。由此可知，当球心到该区域的距离越远，则该小区域的面积越小，立体角也就越小。

需要注意的是，立体角和平面角不同，它更多地描述的是三维空间中的角度范围，而不是平面上的角度范围。因此，立体角通常被用于描述光照、辐射等三维空间中的物理量。

在PBR渲染中，立体角是非常重要的物理量之一。例如，当我们计算材质表面接收到来自某个光源的辐射能量时，我们需要先计算该光源向材质表面发出的辐射通量，然后根据光线传输路径和交点位置等信息，计算该交点处的立体角大小，并最终计算材质表面接收到的辐射能量。

总之，立体角是空间角的一种，用于描述在三维空间中某个位置上的整个空间范围，其单位为立体弧度。在PBR渲染中，它是计算光照和材质反射等重要物理量的基本参数之一。

![image-20230912142717518](.\image-20230912142717518.png)