![image-20231012201707058](.\image-20231012201707058.png)

---

# TBN（切线空间）矩阵推导

$\vec{a} \cdot \vec{b}$， a和b两个向量的点乘，它有两个几何意义：

第一：表示这两个向量的角度

第二：表示a向量投影到b向量上的长度（注意，这里只是长度，而不是一个向量）



![image-20231013152337004](.\image-20231013152337004.png)





如上图所示，在切线空间TBN中有一个三角形 ABC，三点坐标分别为：
$$
A = (x_1, y_1, z_1)
\\ \\
B = (x_2, y_2, z_2)
\\ \\
C = (x_3, y_3, z_3)
$$
同时，在TB平面直角坐标系内，ABC 3点还有一个单独的坐标（u，v）, u为T轴上的值，v为B轴上的值。
$$
A = (u1, v1)
\\ \\
B = (u2, v2)
\\ \\
C = (u3, v3)
$$


然后，边 e1 为 BA边B指向A的向量，e2为BC边，B指向C的向量，e1, e2：
$$
e_1 = A - B = (x_1 - x_2, y_1 - y_2, z_1 - z_2) \iff 
\\ \\
e_2 = C - B = (x_3 - x_2, y_3 - y_2, z_3 - z_2) \iff 
$$
然后边在T轴上的投影为**Δ**u， 在B轴上的投影为**Δ**v，则有e1在T轴上的投影**Δ**U1，e1在B轴上的投影**Δ**V1；同样的，则有e2在T轴上的投影**Δ**U2，e2在B轴上的投影**Δ**V2：
$$
\Delta{U1} = (u1-u2), \Delta{U2} = (u3-u2)
\\ \\
\Delta{V1} = (v1-v2), \Delta{v2} = (v3-v2)
$$


则e1和uv有如下等价关系：
$$
e_1 = \Delta{U_1} \cdot T + \Delta{V_1} \cdot B
\\ \\
e_2 = \Delta{U_2} \cdot T + \Delta{V_2} \cdot B
$$


有了如上关系，我们就可以得到如下的矩阵计算：
$$
\begin{pmatrix}
\Delta{U_1} & \Delta{V_1}
\\
\Delta{U_2} & \Delta{V_2}
\end{pmatrix}
\cdot
\begin{pmatrix}
T
\\
B
\end{pmatrix}
 =
\begin{pmatrix}
e_1
\\
e_2
\end{pmatrix}
$$


自此，我们除了T,B是未知量，其余值均为已知量，因为矩阵没有除法，所以，求TB，我们需要用矩阵求逆的知识进行计算：

设*A*是数域上的一个n阶方阵，若在相同数域上存在另一个n阶矩*B*，使得： *AB*=*BA*=*E*。 则我们称*B*是*A*的逆矩阵，而A则被称为[可逆矩阵](https://baike.baidu.com/item/可逆矩阵/11035614?fromModule=lemma_inlink)。其中，E为[单位矩阵](https://baike.baidu.com/item/单位矩阵/8540268?fromModule=lemma_inlink)。

伴随矩阵求逆法：

![image-20231013160347795](.\image-20231013160347795.png)



所以，我们得到TB矩阵的计算公式如下：
$$
\begin{pmatrix}
T \\ B
\end{pmatrix}
=

\begin{pmatrix}
\Delta{U_1} & \Delta{V_1}
\\
\Delta{U_2} & \Delta{V_2}
\end{pmatrix}^{-1}

\cdot

\begin{pmatrix}
e_1
\\
e_2
\end{pmatrix}
$$


## TBN（切线-副法线-法线）

TBN（切线-副法线-法线）矩阵是用于将纹理空间中的法向量转换为世界空间中的法向量的矩阵。它由三个基向量组成：切线向量、副法线向量和法线向量，构成一个正交矩阵。

下面我们来推导 TBN 矩阵的计算过程。假设有一个三角形网格，在顶点中存储了切线向量 `t`、副法线向量 `b` 和法线向量 `n`，并且在纹理坐标系中存储了每个顶点的切向量 `T`、副法向量 `B` 和法向量 `N`。则可以通过以下步骤计算 TBN 矩阵：

1. 计算变换矩阵

首先需要计算一个变换矩阵，将切向量 `T`、副法向量 `B` 和法向量 `N` 转换为世界空间中的向量。该变换矩阵为：

```
[Tx Bx Nx]
[Ty By Ny]
[Tz Bz Nz]
```

其中 `[Tx Ty Tz]`、`[Bx By Bz]` 和 `[Nx Ny Nz]` 分别表示切向量、副法向量和法向量在世界空间中的坐标。

2. 构造 TBN 矩阵

然后需要将纹理空间中的切向量、副法向量和法向量转换为世界空间中的向量。这可以通过将纹理空间的向量与变换矩阵相乘得到：

```
T' = T * [Tx Ty Tz]
B' = B * [Bx By Bz]
N' = N * [Nx Ny Nz]
```

其中 `T'`、`B'` 和 `N'` 分别表示纹理空间中的切向量、副法向量和法向量在世界空间中的坐标。

最后，可以将 `T'`、`B'` 和 `N'` 归一化，并将它们组成一个正交矩阵作为 TBN 矩阵：

```
| Tx' Bx' Nx' |
| Ty' By' Ny' |
| Tz' Bz' Nz' |
```

现在，可以使用 TBN 矩阵将纹理空间中的法向量转换为世界空间中的法向量了。具体而言，对于每个片元，可以将其法向量 `(nx, ny, nz)` 乘以 TBN 矩阵，得到在世界空间中的法向量 `(nx', ny', nz')`：

```
[ nx' ]   [ Tx' Ty' Tz' ]   [ nx ]
[ ny' ] = [ Bx' By' Bz' ] * [ ny ]
[ nz' ]   [ Nx' Ny' Nz' ]   [ nz ]
```





## 矩阵求逆

矩阵的逆是指与原矩阵相乘等于单位矩阵的矩阵。一般地，如果一个 $n\times n$ 的矩阵 $A$ 是可逆的，则其逆矩阵 $A^{-1}$ 满足以下条件：

$$AA^{-1} = A^{-1}A = I$$

其中 $I$ 为 $n\times n$ 的单位矩阵。

下面我们介绍两种常用的方法来求矩阵的逆：

1. 初等行变换法

该方法基于初等矩阵和初等行变换的概念，通过多次进行简单的矩阵变换来实现求逆的过程。具体步骤如下：

- 构造一个 $(2n)\times n$ 的矩阵 $[A\ |\ I]$，其中 $I$ 为 $n\times n$ 的单位矩阵。
- 对矩阵 $[A\ |\ I]$ 进行初等行变换，直到左半部分成为单位矩阵（也就是 $A$ 被转化为上三角矩阵）：

    - 交换两行或两列；
    - 用非零标量乘以一行或一列；
    - 将一行加上另一行的某个倍数。

- 对矩阵 $[A\ |\ I]$ 进行逆序的初等行变换，使得最终形成矩阵 $[I\ |\ A^{-1}]$。

需要注意的是，如果中间过程中出现了全零行或全零列，那么该方法无法求解逆矩阵。此外，该方法的时间复杂度为 $O(n^3)$，并且需要使用到比较复杂的数学知识，因此不太适合在实际应用中使用。

2. 高斯-约旦消元法

该方法也是基于初等矩阵和初等行变换的概念，但采用了不同的求解方式。具体步骤如下：

- 构造一个 $(n\times 2n)$ 的增广矩阵 $[A\ |\ I]$，其中 $I$ 为 $n\times n$ 的单位矩阵。
- 对矩阵 $[A\ |\ I]$ 进行高斯-约旦消元，将左半部分转化为单位矩阵。
- 对右半部分进行逆序消元，得到最终的矩阵 $[I\ |\ A^{-1}]$。

高斯-约旦消元法可以通过简单的迭代过程来实现，时间复杂度为 $O(n^3)$，并且通常比初等行变换法效率更高。但该方法同样存在一些问题，例如可能会出现精度误差等问题。

需要注意的是，在实际应用中，可以使用一些第三方库（例如 Eigen、OpenCV 等）来求解矩阵的逆，这些库通常提供了高效且准确的求解方法。
