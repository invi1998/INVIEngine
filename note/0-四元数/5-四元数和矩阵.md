## 四元数转矩阵详细推导

基于左手坐标系的任意轴旋转矩阵
$$
R = \begin{bmatrix}  cos(θ) + u_x^2 * (1 - cos(θ))   &  u_x * u_y * (1 - cos(θ)) - u_z * sin(θ)  &  u_x * u_z * (1 - cos(θ)) + u_y * sin(θ) \\
      u_y * u_x * (1 - cos(θ)) + u_z * sin(θ)  &  cos(θ) + u_y^2 * (1 - cos(θ))  &   u_y * u_z * (1 - cos(θ)) - u_x * sin(θ) \\
     u_z * u_x * (1 - cos(θ)) - u_y * sin(θ)  &  u_z * u_y * (1 - cos(θ)) + u_x * sin(θ)  &   cos(θ) + u_z^2 * (1 - cos(θ))   \\
\end{bmatrix}
$$
然后我们有四元数g
$$
g = [\cos{\frac{θ}{2}}, \sin{\frac{θ}{2}u}] = [\cos{\frac{θ}{2}}, \sin{\frac{θ}{2}u_x}, \sin{\frac{θ}{2}u_y}, \sin{\frac{θ}{2}u_z}]
$$
同时，我们的x,y,z,w可以表示为如下等式
$$
w = \cos{\frac{θ}{2}}\\
x = \sin{\frac{θ}{2}u_x}\\
y = \sin{\frac{θ}{2}u_y}\\
z = \sin{\frac{θ}{2}u_z}
$$


然后我们将上述矩阵转为四元数，结果为
$$
Q = \begin{bmatrix}
1-2y^2-2z^2 & 2xy+2wz & 2xz-2wy\\
2xy-2wz & 1-2x^2-2z^2 & 2yz+2wx\\
2xz+2wy & 2yz-2wx & 1-2x^2-2y^2\\
\end{bmatrix}
$$
我们先看旋转矩阵的11项
$$
cos(θ) + u_x^2 * (1 - cos(θ))\\
= cos(θ) + u_x^2 - u_x^2cos(θ)\\
= 1-1 + cos(θ) + u_x^2 - u_x^2cos(θ)\\
= 1 -(1-cos(θ) - u_x^2 + u_x^2cos(θ))\\
因为有如下等式关系\\
(1-a-b^2+b^2a)=(1-b^2)(1-a)\\
所以式子等于\\
= 1-(1-u_x^2)(1-cos(θ))
$$
三角函数二倍角公式

![image-20240226110239959](.\image-20240226110239959.png)

根据二倍角公式，上述等式可以继续化简
$$
= 1-(1-u_x^2)(1-cos(θ))\\
= 1-(1-u_x^2)(1-(1-2\sin^2{\frac{θ}{2}}))\\
= 1-(1-u_x^2)(2\sin^2{\frac{θ}{2}})\\
= 1-(2\sin^2{\frac{θ}{2}} - u_x^2 2\sin^2{\frac{θ}{2}})\\
= 1- 2\sin^2{\frac{θ}{2}} + u_x^2 2\sin^2{\frac{θ}{2}}\\
= 1- 2(1-\cos^2{\frac{θ}{2}}) + 2u_x^2\sin^2{\frac{θ}{2}}\\
= 1 - 2 + 2\cos^2{\frac{θ}{2}} + 2u_x^2\sin^2{\frac{θ}{2}}\\
= -1 + 2\cos^2{\frac{θ}{2}} + 2(u_x\sin{\frac{θ}{2}})^2\\
带入我们的x,y,z,w，得到\\
= -1 + 2w^2 + 2x^2
$$
由此，我们将第一项由普通代数推导为了四元数。

### 四元数转矩阵标准形式推导

但是我们从上面的推导，可以看到，我们推导的式子和标准的式子不一样，这是为啥？这不代表我们的式子是错误的，其实这两者是等效的，即：
$$
1-2y^2-2z^2 == -1 + 2w^2 + 2x^2
$$
我们从式子的这里开始进行另一种推导
$$
= 1-(1-u_x^2)(2\sin^2{\frac{θ}{2}})\\
因为我们的u是单位向量，所以有 u_x^2 + u_y^2 + u_z^2 = 1，所以1-u_x^2 = u_y^2 + u_z^2\\
= 1 - (u_y^2 + u_z^2)(2\sin^2{\frac{θ}{2}})\\
= 1 - 2u_y^2\sin^2{\frac{θ}{2}} - 2u_z^2\sin^2{\frac{θ}{2}}\\
带入x,y,z,w得到，经过一系列化简得到\\
= 1-2y^2-2z^2
$$
