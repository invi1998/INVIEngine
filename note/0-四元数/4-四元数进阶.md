## 四元数求逆公式推导

我们之前得到了一个四元数求逆的公式（**共轭除以模的平方**）
$$
g^{-1} = \frac{g^*}{|g|^2}
$$
首先，我们有如下公式（定理）
$$
gg^{-1}=g^{-1}g=1\\
g=[w, \vec{v}]=w+\vec{v}\\
g^*=[w, -\vec{v}]=w-\vec{v}\\
g_1g_2 = w_1w_2 - \vec{v_1}\cdot\vec{v_2}+w_1\vec{v_2}+w_2\vec{v_1}-\vec{v_1}\times\vec{v_2}\\
gg^* = g^*g= w^2+\vec{v}^2=w^2+x^2+y^2+z^2 = |g|^2
$$
现在来进行证明推导$g^{-1} = \frac{g^*}{|g|^2}$
$$
gg^{-1}=1\\
两边同时乘以g^*\\
g^*gg^{-1}=g^*\\
因为g^*g等于四元数g模的平方，是一个实数，复数（四元数不能除，但是实数可以）,所以就有\\
|g|^2g^{-1}=g^*\\
g^{-1}=\frac{g^*}{|g|^2}
$$


## 四元数对数

在数学中，对数是对求幂的逆运算，正如除法是乘法的逆运算，反之亦然。 这意味着一个数字的对数是必须产生另一个固定数字（基数）的指数。下图是实数的对数图表

![img](.\resize,m_lfit,limit_1,h_1080)

这里回顾一下前面学习复数时的欧拉公式
$$
e^{i\theta}=\cos{\theta}+\sin{\theta}i
$$
对于我们的超复数（四元数）,i部分用v来代替，那这个式子是不是就是如下形式（四元数的欧拉等式）
$$
对于四元数g=[w, \vec{v}]\\
e^{\vec{v}\theta}=w\cos{\theta} + \sin{\theta}\vec{v}\\
一般我们四元数都考虑单位四元数，所以w都为1\\
= \cos{\theta} + \sin{\theta}\vec{v}\\
= \cos{\theta} + \sin{\theta}\vec{v_x}+ \sin{\theta}\vec{v_y}+ \sin{\theta}\vec{v_z}\\
\\写成对数形式\\ \\
\log_e^g=\vec{v}\theta
$$
这样我们就能利用四元数做很多对数计算，比如
$$
\log_e^{g_1g_2} = \log_e^{g_1}+\log_e^{g_2} = \vec{v_1}\theta_1 + \vec{v_2}\theta_2
$$


## 四元数求幂

对于复数来说，我们求一个复数a的n次幂，我们可以利用欧拉公式进行如下计算
$$
a^n = (e^{i\theta})^n = e^{i\theta n} = \cos{\theta}.n + \sin{\theta}.i.n
$$
那推广到超复数（四元数）上来，n个四元数g相乘（g的n次幂）他的结果，也可以利用欧拉公式进行如下计算（这里四元数做了归一化了已经，后续四元数基本也都是再归一化后的基础上进行讨论）(注意这里$\theta = \frac{\theta}{2}$)
$$
g^n = (\cos{\theta} + \sin{\theta}\vec{v})^n\\
= \cos{(\theta n)} + \sin{(\theta n)}\vec{v}\\
= e^{\theta n \vec{v}}\\
\theta = \frac{\theta}{2}\\
g^n = \cos{\frac{\theta}{2}n} + \sin{\frac{\theta}{2}n}\vec{v} = e^{\frac{\theta}{2}n\vec{v}}
$$
我们知道对于常数的幂运算，有如下规则
$$
(a^n)^s = a^{ns}
$$
但是对于四元数，这个规则并不适用
$$
(\vec{g}^n)s \neq (\vec{g})^{ns}
$$




## 纯四元数

$g = [w, \vec{v}]$，单我们的实部w=0的时候，即$g=[0, \vec{v}]$这样的四元数我们称为纯四元数



## 四元数旋转

这里我们先回顾一下复数旋转。我们有两个复数 a，b，他们的角度分别为θ和φ，他们相乘结果如下：
$$
ab = e^{i(\theta+\phi)}
$$
对于两个复数相乘，他的本质其实就是两个角度相加
$$
g_1g_2
$$


![image-20240219143448376](.\image-20240219143448376.png)

同样，对于我们的四元数，也是一样的本质存在，我们将一个四元数乘以另外的一个四元数，也就是将我们的四元数做了一次旋转。但是四元数这样旋转会有什么问题呢？因为四元数w部分的存在，所以导致我们将一个四元数旋转（相乘）的时候，会使得这个四元数在w轴上进行偏移，表现在几何中，就比如我们利用四元数对一个球体进行旋转，旋转之后，会发现这个求不仅旋转了，而且球还变大了。

![image-20240221181719059](.\image-20240221181719059.png)

那如何解决这个问题？我们在旋转的基础上再乘以这个四元数的逆，即最终的旋转公式：
$$
g_1g_2g_1^{-1}\\
其中，这些四元数有如下要求：\\
g_1，g_1^{-1}要是单位四元数（归一化）\\
g_2这个旋转角度四元数要是一个纯四元数\\
那既然g_1是个单位四元数，那么根据单位四元数性质，g^{-1}=g^{*}，所以这个旋转公式也可以写成\\
g_1g_2g^*
$$

我们此前在学习向量的时候，对于一个向量$\vec{v}$的其次项w，w为0的时候，我们表示的是一个向量，当其次项w为1的时候，我们表示的是一个点。对应到复数这里，也就是为什么我们上面的四元数旋转公式里的$g_2$项要是一个纯四元数（其次项（实数部分w）为0），因为我们旋转，要传入的是一个旋转方向和旋转角度，这是一个向量，所以这里其次项要为0。这也算是这里为什么要是纯四元数的一个额外理解思路。

![image-20240222102722365](.\image-20240222102722365.png)

如上图所示，我们的旋转四元数为$p = i + 0j+0k$表示绕i轴旋转，然后我们绕着i轴旋转45°，旋转结果如下 [Visualizing quaternions | 3blue1brown + Ben Eater](https://eater.net/quaternions/video/intro)

![image-20240222103039249](.\image-20240222103039249.png)

从上图旋转结果我们可以看到，我们将球绕i轴旋转了90°，但是实际上我们传入的θ值为45°，这也验证了为什么我们上面说，在四元数中，$\theta = \frac{\theta}{2}\\$​。但是其实也不是，其实就是旋转了45°，只是这个旋转如果不做校正的话，旋转结果是被扩大了的（缩放），做了校正后（乘以四元数的逆，反向缩放再旋转45°）才正常，所以一个正常的旋转，你θ为45°，实际旋转角度是90度

![1708570697141](.\1708570697141.gif)

然后我们继续看一下，如果我们在进行四元数旋转的时候，不最后乘以四元数的逆，会出现什么情况，依旧是绕i轴旋转，旋转45°结果如下。

![image-20240222103937417](.\image-20240222103937417.png)

从旋转结果可以看到，如果我们最后不乘以四元数的逆，那么经过旋转之后球体变大了，而且旋转也出现了偏差。所以这个逆矩阵的作用其实就是对旋转结果做一个校正，我们可以在此基础上进行手动更改q2的旋转值进行手动校正，如下

![QQ录屏20240222104402 -original-original](.\QQ录屏20240222104402 -original-original.gif)

可以看到，经过逆矩阵的校正之后，我们的旋转结果就正常了（注意这里旋转的轴变了，变成k了，录屏的时候忘记把变量统一了，不过无所谓，知道结论验证正确就行）



## 已知四元数求角度

$$
g = [w, \vec{v}]\\
= [\cos{\theta}, \sin{\theta}\vec{v}]\\
\cos{\theta} = w\\
利用反余弦即可求出\theta值\\
\theta = \arccos{w}\\
$$





## 四元数旋转的特殊情况证明推导

一般形式的四元数旋转（绕轴旋转）

如图，我们需要将$\vec{v}$旋转到$\vec{v_1}$，然后我们有如下规定，$\vec{n}$是一个单位向量，$\vec{n}$垂直于$\vec{v}$，然后$\vec{n}$和$\vec{v}$叉乘的结果我们定为$\vec{w}$。

![image-20240223155357399](.\image-20240223155357399.png)

现在我们怎么用已知量$\vec{v}，\vec{n}$来求我们的$\vec{v_1}$。我们先来看一下这个的顶视图

![image-20240223160232680](.\image-20240223160232680.png)
$$
\vec{v_1}的垂直向量（v向的量）我们写为 \vec{v_{1\bot}}\\
\vec{v_1}的水平向量（w向的量）我们写为 \vec{v_{1||}}\\
那么这两个标量有如下关系\\
|\vec{v_{1\bot}}| = |\vec{v}|\cos{\theta}\\
|\vec{v_{1||}}| = |\vec{w}|\sin{\theta}\\
第一眼是不是这与我们的三角函数自觉不对应？注意：因为我们说了，\vec{v_1}是由\vec{v}旋转\theta角度得到的\\
所以这两个向量长度是一样的，而在我们的三角函数里，本来是\\
|\vec{v_{1\bot}}| = |\vec{v_1}|cos\theta\\
因为|\vec{v}| == |\vec{v_1}|，所以\\
|\vec{v_{1\bot}}| = |\vec{v}|\cos{\theta}\\
同理对于\vec{w}也是如此，所以也就有\\
|\vec{v_{1||}}| = |\vec{w}|\sin{\theta}\\
带入向量计算，这两个向量相加，就得到了\vec{v_1}\\
\vec{v_1} = \vec{v_{1\bot}} + \vec{v_{1||}}\\
= \vec{v}\cos{\theta} + \vec{w}\sin{\theta}\\
= \vec{v}\cos{\theta} + (\vec{n}\times\vec{v})\sin{\theta}\\
然后我们这里把向量写成四元数形式\\
\vec{v} = [0, \vec{v}]\\
\vec{v_1} = [0, \vec{v_1}]\\
\vec{n} = [0, \vec{n}]\\
本来这里应该是直接带入四元数，然后将上面的式子展开，但是直接展开不太好展，我们逆向推导，看能否推导出这样的式子\\
四元数n,v相乘，根据公式\\
g_1g_2 = w_1w_2 - \vec{v_1}\cdot\vec{v_2}+w_1\vec{v_2}+w_2\vec{v_1}+\vec{v_1}\times\vec{v_2}\\
nv = -\vec{n}\cdot \vec{v} - \vec{n}\times\vec{v}\\
因为n和v垂直，所以他们的点乘结果为0，所以式子等于\\
nv = \vec{n}\times\vec{v} = \vec{w}\\
然后继续。将这个四元带入到上面的式子中\\
\vec{v_1} = \vec{v}\cos{\theta} + (\vec{n}\times\vec{v})\sin{\theta}\\
v = v\cos{\theta} + nv\sin{\theta}\\
向量乘法是没有结合律的，但是我们四元数是有结合律分配率的，所以这里可以把四元数v提出来(注意，四元数同样没有交换律，所以注意顺序)\\
= (\cos{\theta} + n\sin{\theta})v\\
然后根据欧拉等式，就有\\
= e^{n\theta}v\\
要满足这个等式，是不是就得有个前提，就是n是一个复数，\\
我们只说了n是四元数，没有说n是复数，但是其实这里n作为一个单位四元数，它就是一个复数，证明略\\
$$
通过上述证明过程，我们得到了如下等式
$$
v_1 = e^{n\theta}v = ve^{-n\theta}\\
nv = n\times v\\
vn = v\times n = - n\times v = -nv
$$


### 四元数任意轴旋转证明推导

![image-20240223180236752](.\image-20240223180236752.png)

如图，我们将v向量旋转θ°，旋转到$v_1$向量。

然后我们将向量v做一下拆分，分别在n向和水平面向做投影

![image-20240223180608377](.\image-20240223180608377.png)
$$
\vec{v} = \vec{v_{||}} + \vec{v_{\bot}}
$$
然后我们进一步对$\vec{v_1}$也做同样的投影拆分，如下

![image-20240223181000991](.\image-20240223181000991.png)

然后，因为我们是再四元数的基础上进行的讨论,而且他们都是单位四元数，所以对于这些向量，我们可以写成如下：
$$
v = [0, v]\\
v_1 = [0, v_1]\\
v_{||} = v_{1 ||}= [0, v_{||}]  投影都是一个\\
v_{\bot} = [0, v_{\bot}]\\
v_{1\bot} = [0. v_{1\bot}]\\
$$
我们现在的要做的，其实和之前是一样的，我们希望用我们当前已知的四元数来表示我们未知的四元数
$$
v_1 = v_{||} + v_{1\bot}\\
$$
可以看到，这里就只有这个v_1的垂直轴是未知的，那么我们引入一个新的轴（四元数）w，w是v垂直投影和v的垂直投影叉乘得到的。

![image-20240223181931164](.\image-20240223181931164.png)
$$
v_1 = v_{||} + v_{1\bot}\\
w = v_{||} \times v_{\bot}\\
根据我们之前推断的，要求出v_{1\bot}，直接带入公式\\
v_{1\bot} = v_{\bot} \cos{\theta} + w\sin{\theta}\\
= e^{n\theta}v_{\bot}\\
带入求v_1得到\\
v_1 = v_{n} + e^{n\theta}v_{\bot}
$$
