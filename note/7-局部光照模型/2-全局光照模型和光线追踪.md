# 光线追踪和全局光照模型



## 光线追踪

光线追踪是计算机图形学中一种用于生成逼真图像的算法。与传统的渲染技术不同，光线追踪通过模拟光在场景中的传播过程来计算每个像素点的颜色和亮度，能够更加准确地模拟真实世界中的光照效果。

光线追踪通常分为以下步骤：

1. 从摄像机位置开始，向屏幕上的每个像素发射一条主光线。

2. 对于每条主光线，依次检测它是否与场景中的物体相交。

3. 如果光线与某个物体相交，则需要进一步判断它是否能够照射到当前像素点。这个过程通常包括计算物体表面的法向量、光线入射角、折射率等因素，并根据这些因素判断光线是否被物体表面遮蔽、反射或折射。

4. 如果光线能够照射到当前像素点，则需要计算它对像素的贡献。这个过程通常根据物体表面的材质特性、光源的属性以及光线传播路径中的散射、吸收和反射等因素来决定。

5. 如果光线无法照射到当前像素点，则需要继续追踪该光线的路径，计算出光线经过多次反射和折射后最终到达屏幕的位置，并将其贡献累加到当前像素点的颜色中。

6. 对于所有主光线的贡献进行累加，并将结果作为像素的颜色和亮度值输出。

光线追踪能够较好地模拟真实世界中的光照效果，包括反射、折射、阴影和次表面散射等复杂物理现象。但其缺陷在于计算复杂度较高，需要大量的计算资源和时间，并且对光源的数量和阴影的处理比较敏感。



### 光线追踪解决方案

现今的光线追踪方案主要分为以下几类：

1. 路径追踪，传统光线追踪：传统光线追踪通常采用递归算法，从摄像机位置开始，依次跟踪每条光线与场景中物体的交点，并计算光线的反射、折射和散射等影响。这种方法能够模拟真实世界中的光照效果，但需要大量的计算资源和时间。

2. 蒙特卡罗光线追踪：蒙特卡罗光线追踪使用随机数方法来近似求解光线传输过程中的积分，对函数值进行多次采样求均值作为积分值的近似。这种方法能够有效地处理复杂的散射和吸收现象，并且可以通过并行计算来提高计算效率。

3. 基于辐射度（PBR）的光线追踪：基于辐射度的光线追踪使用辐射度来描述光线能量的传播，通过对辐射度的传输方程进行求解来计算光线的传输过程。这种方法在处理多个光源和阴影时有很好的效果，并且可以结合GPU加速来提高计算效率。

4. 深度学习光线追踪：深度学习光线追踪是一种新兴的光线追踪方法，它使用神经网络来学习光线传输过程中的物理规律，并通过训练来优化渲染质量和计算效率。这种方法在处理大规模场景和复杂材质时具有很好的效果。



#### path Tracying

Path Tracing（路径追踪）是一种基于Monte Carlo方法的光线追踪算法，用于计算三维场景中的全局照明。它能够模拟真实世界中的光照效果，并能够处理反射、折射、次表面散射和阴影等多种图像效果。

Path Tracing的主要思想是通过随机采样的方法来近似计算光的路径和能量传输过程。具体而言，该算法从摄像机位置开始，沿着每个像素产生一条初始光线，并在光线与物体相交后，根据物体表面的材质特性，以一定概率产生新的光线，并对其进行迭代和计算，直到达到迭代次数或光线能量低于阈值为止。

在路径追踪过程中，需要使用各种概率分布函数来描述光线与物体的交点、入射角度、反射和折射等现象，并根据这些概率分布函数来计算光线反射、折射、散射的概率和方向，最终累加所有光线的颜色和能量，得到像素的颜色和亮度值。

与其他光线追踪算法相比，Path Tracing具有较好的渲染效果和物理意义，但计算复杂度较高，需要大量的计算资源和时间，并且容易出现噪点和收敛问题。因此，在实际应用中，需要结合优化手段和抗锯齿技术等方法来提高算法的计算效率和渲染质量。



#### whitted-type

Whitted-type光线追踪是一种经典的光线追踪算法，由Andrew S. Glassner和Turner Whitted于1980年代提出。它采用递归的方式跟踪从摄像机发射的光线，并模拟光线与物体的相交、反射、折射和阴影等现象，能够产生逼真的渲染效果。

与其他光线追踪算法不同，Whitted-type光线追踪只考虑了光线的直接路径和一级间接路径，即仅计算从摄像机到物体表面再到光源之间的路径，以及从摄像机到物体表面再到环境中其他物体表面之间的路径。这种方法可以有效地减少计算量，但不能处理多次散射和次表面散射等复杂现象。

Whitted-type光线追踪的主要优点在于计算速度较快，可以用于实时渲染和交互式应用中。同时，该算法还具有易于理解和实现的特点，可以帮助理解光线追踪算法的基本原理和流程。

然而，Whitted-type光线追踪也存在着一些缺陷，如无法处理多次反射、折射和次表面散射等复杂现象，容易产生锯齿和噪点等问题。因此，在实际应用中，需要根据具体场景和效果需求选择合适的光线追踪算法，并结合优化手段来提高计算效率和渲染质量。

#### distrubution

在计算机图形学中，Distribution（分布）通常指的是用某种数学函数来描述物体表面或介质中的光照分布规律。这些分布函数主要用于模拟渲染过程中的光线反射、折射和散射等现象，并能够提高图像的真实感和逼真度。

常见的分布函数包括：

1. Lambertian 分布：也称为漫反射分布，用于描述粗糙表面的光照分布规律。Lambertian分布函数认为表面反射出的光线方向是均匀分布的，与观察角度无关。

2. Phong 分布：Phong分布函数可以用于模拟光线在平滑表面上的反射和折射。它由一个镜面反射项和一个漫反射项组成，可以调节反射光线的亮度和聚焦效果。

3. Blinn-Phong 分布：Blinn-Phong分布函数是Phong分布函数的一种改进，可以更好地描述光线在粗糙表面上的反射和折射。它主要利用了法向量和半程向量之间的关系来计算光照分布规律。

4. Beckmann 分布：Beckmann分布函数用于描述金属或镜面材质表面的光照分布规律。它可以通过表面粗糙度参数来调节反射光线的聚焦程度和散射强度。

5. GGX 分布：GGX分布函数是一种近年来比较流行的分布函数，它可以很好地模拟各种材质表面的光照分布规律，并且具有较好的物理意义和数值稳定性。

不同的分布函数适用于不同的场景和效果需求，在实际应用中需要根据具体情况进行选择和调整。

#### bidirtctional path

双向路径追踪（Bidirectional Path Tracing）是一种用于计算全局照明的光线追踪算法，由James Kajiya于1986年提出。它结合了正向和反向光线追踪的优点，能够很好地处理复杂场景中的反射、折射和次表面散射等多种光学现象。

与传统的光线追踪算法不同，双向路径追踪将光线追踪分为两个阶段：从摄像机发射光线到物体表面和从光源发射光线到物体表面。在这两个阶段中，分别以随机采样的方式跟踪光线，并生成两个路径上的交点序列。然后，通过对这两个交点序列进行匹配和组合，得到所有可能的路径，并计算路径上每个交点的贡献，最终累加所有路径的颜色和能量，得到像素的颜色和亮度值。

双向路径追踪的主要优点在于能够有效地处理多次反射和折射等复杂光学现象，并且可以避免传统光线追踪中出现的细节丢失问题。同时，该算法还具有较好的渲染效果和真实性，可以用于高质量图形渲染和动画制作等领域。

然而，双向路径追踪也存在着一些缺陷，如计算复杂度较高，需要大量的计算资源和时间，并且容易产生噪点和收敛问题。因此，在实际应用中，需要结合优化手段和抗锯齿技术等方法来提高算法的计算效率和渲染质量。

#### metropolls

Metropolis算法（Metropolis-Hastings algorithm）是一种用于产生从某个复杂分布中采样的蒙特卡罗方法，由Nicholas Metropolis和Edward Teller于1953年提出。该算法可以用于求解各种实际问题，如统计物理学、机器学习等领域。

Metropolis算法主要通过马尔可夫链的方式进行采样，其基本流程如下：

1. 选定一个初态x0，并指定一个转移核函数q(x|x')，表示在当前状态为x'时，转移到下一个状态为x的概率密度。

2. 对于第i步，生成新的候选状态y~q(xi|y)，即以xi为中心，按照概率密度函数q(xi|y)生成新的状态y。

3. 计算接受概率α=min{p(y)q(xi|y)/(p(xi)q(y|xi))}，其中p(x)表示真实的目标概率分布函数。

4. 以概率α接受新状态y，并转移到新状态；否则，以概率1-α保持原状态。

5. 继续迭代执行步骤2~4，直到采样点足够多或达到收敛条件为止。

Metropolis算法不需要知道目标分布的具体形式，只需要能够计算分布函数在某个位置的值即可。但这种自适应的采样方法也会面临样本相关性和收敛速度较慢等问题。因此，近年来，有很多改进的Metropolis算法被提出，如Adaptive Metropolis算法、Delayed Rejection Metropolis算法等，以提高采样效率和精度。

#### point based global illumination

点光源全局照明（Point-Based Global Illumination）是一种计算全局照明的方法，由Hugues Hoppe于1999年提出。它基于点云数据结构，通过在物体表面上投射大量随机采样的点，并利用这些点来近似计算光的传播过程。

具体而言，点光源全局照明主要包括以下几个步骤：

1. 在物体表面上生成一定数量的随机采样点，并记录每个点的位置、法向量和颜色值等信息。

2. 对于每个点，在其周围产生一定数量的虚拟光线，并根据光线与物体相交的位置和法向量等信息，计算光线的颜色和能量贡献。

3. 将计算得到的颜色和能量值分配给离该点最近的若干个采样点，并在点之间进行插值或平滑处理，得到每个点的总颜色和能量值。

4. 根据点的总颜色和能量值，以及各点之间的距离和权重等参数，计算像素的颜色和亮度值，并输出最终渲染结果。

点光源全局照明的主要优点在于可以快速计算全局照明效果，同时还能够很好地处理阴影、反射和漫反射等多种光学现象。此外，由于点云数据结构具有较好的可扩展性和灵活性，因此该方法还可以被应用于实时渲染、远景渲染和动态场景渲染等领域。

然而，点光源全局照明也存在一些缺陷，如对场景密度和采样点数量等参数较为敏感，容易产生噪点和收敛问题；同时，其计算精度和渲染效果也受到点分布的影响，需要进行一定的调整和优化。

#### photon mapping

光子映射（Photon Mapping）是一种用于计算全局照明的光线追踪算法，由Henrik Wann Jensen于1996年提出。它通过将光线跟踪分为两个阶段，包括光子映射和辅助光线追踪，实现了逼真的渲染效果。

具体而言，光子映射的主要流程如下：

1. 光子映射阶段：从光源处发射大量的光子，并根据光子与物体表面相交的位置、方向、能量和颜色等信息，记录在一棵光子图（Photon Map）中。

2. 辅助光线追踪阶段：从摄像机处发射眼线（Eye Ray），并以随机采样的方式跟踪反射、折射和漫反射等光学现象。每次碰到物体表面时，利用光子图快速搜索相应的光子，并根据光子的位置、方向、能量和颜色等信息，计算像素的颜色和亮度值。

光子映射的主要优点在于能够很好地处理多次反射和折射等复杂光学现象，并且具有较好的渲染效果和真实性。此外，光子映射还可以进行预处理和缓存，可以支持实时或交互式应用。

然而，光子映射也存在着一些缺陷，如需要大量的内存和计算资源来存储和搜索光子图，容易产生噪点和伪影等问题。因此，在实际应用中，需要结合优化手段和抗锯齿技术等方法来提高算法的计算效率和渲染质量。