![image-20231206151748845](.\image-20231206151748845.png)

如图在球面上会产生一些局部阴影

# 阴影粉刺（阴影失真）和斜率偏移补偿技术

在游戏图形学中，阴影粉刺现象指的是在使用基于光栅化的渲染器（比如DX12）生成阴影时出现的一些异常视觉效果。这种现象通常表现为黑色或白色的小点或斑块，出现在阴影边缘附近或阴影与非阴影区域之间的过渡区域。

这种现象主要是由于在光栅化渲染器中，深度值（用于确定物体的远近关系）以整数形式存储。当两个物体表面的深度值非常接近时，渲染器可能会出现“深度偏差”（depth bias）问题，导致部分表面没有正确地被阴影覆盖，从而产生了阴影粉刺现象。

为了解决这个问题，可以通过调整深度偏差参数、增加阴影贴图分辨率等方式来减少阴影粉刺现象的发生。另外，对于某些情况下无法避免的阴影粉刺，也可以采用后处理技术来进行修复。

在光栅化渲染器中，在绘制阴影时，通常采用深度测试来检测像素是否在阴影内部。但是，由于深度缓冲区分辨率有限，即使使用最小可能的深度偏差，仍然会导致阴影粉刺等问题。

为了解决这个问题，可以采用斜率偏移补偿技术。该技术基于表面法线和光源方向计算出偏移量，并将其应用于深度值，从而产生更准确的阴影。通过调整偏移量，可以有效地避免阴影粉刺等问题。

需要注意的是，斜率偏移补偿技术的效果取决于表面法线的方向。如果表面法线与光源方向相同或相反，那么产生的偏移量将非常小，从而无法有效减少阴影粉刺。因此，斜率偏移补偿技术通常与其他技术结合使用，以获得更好的阴影效果。



![image-20231206151917582](.\image-20231206151917582.png)

关于阴影失真，我们可以换个说法。

![img](.\shadow_mapping_acne_diagram.png)



因为阴影贴图受限于分辨率，在距离光源比较远的情况下，多个片段可能从深度贴图的同一个值中去采样。图片每个斜坡代表深度贴图一个单独的纹理像素。你可以看到，多个片段从同一个深度值进行采样。

虽然很多时候没问题，但是当光源以一个角度朝向表面的时候就会出问题，这种情况下深度贴图也是从一个角度下进行渲染的。多个片段就会从同一个斜坡的深度纹理像素中采样，有些在地板上面，有些在地板下面；这样我们所得到的阴影就有了差异。因为这个，有些片段被认为是在阴影之中，有些不在，由此产生了图片中的条纹样式。

我们可以用一个叫做**阴影偏移**（shadow bias）的技巧来解决这个问题，我们简单的对表面的深度（或深度贴图）应用一个偏移量，这样片段就不会被错误地认为在表面之下了。

![img](.\shadow_mapping_acne_bias.png)

使用了偏移量后，所有采样点都获得了比表面深度更小的深度值，这样整个表面就正确地被照亮，没有任何阴影。

DX12

```c++
	D3D12_GRAPHICS_PIPELINE_STATE_DESC& GPSDesc = DirectXPipelineState->GetGPSDesc();

	// 偏移补偿 为了解决阴影失真问题
	// d = 1 / pow(2, 24);  2^24
	// b（偏移量） = DepthBias（固定偏移量） * d + SlopeScaledDepthBias（缩放因子） * MaxDepthSlope（最大深度）
	GPSDesc.RasterizerState.DepthBias = 100000;				// 斜率 固定偏移量
	GPSDesc.RasterizerState.DepthBiasClamp = 0.0f;			// 缩放	偏移量的限制，偏移量上限，最大偏移量
	GPSDesc.RasterizerState.SlopeScaledDepthBias = 1.0f;	// 偏移量 根据多边形斜率来控制的一个缩放因子
```



### 悬浮

使用阴影偏移的一个缺点是你对物体的实际深度应用了平移。偏移有可能足够大，以至于可以看出阴影相对实际物体位置的偏移，你可以从下图看到这个现象（这是一个夸张的偏移值）：

![img](.\shadow_mapping_peter_panning.png)

这个阴影失真叫做悬浮(Peter Panning)，因为物体看起来轻轻悬浮在表面之上（译注Peter Pan就是童话彼得潘，而panning有平移、悬浮之意，而且彼得潘是个会飞的男孩…）。我们可以使用一个叫技巧解决大部分的Peter panning问题：当渲染深度贴图时候使用正面剔除（front face culling）你也许记得在面剔除教程中OpenGL默认是背面剔除。我们要告诉OpenGL我们要剔除正面。

因为我们只需要深度贴图的深度值，对于实体物体无论我们用它们的正面还是背面都没问题。使用背面深度不会有错误，因为阴影在物体内部有错误我们也看不见。

![img](.\shadow_mapping_culling.png)